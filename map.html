<!-- ===== RESERVATION MODAL ===== -->
<div id="modal" class="modal hidden"
  style="position:fixed;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:999;">
  <div style="background:#fff;padding:20px 28px;border-radius:10px;color:#000;max-width:320px;">
    <h3 id="modalTitle" style="margin-top:0;font-weight:700">Reserve Slot</h3>
    <p id="modalText">Confirm?</p>
    <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end;">
      <button id="cancelBtn" style="padding:8px 14px;background:#ccc;border:none;border-radius:6px;cursor:pointer;">Cancel</button>
      <button id="confirmBtn" style="padding:8px 14px;background:#2c5364;color:#fff;border:none;border-radius:6px;cursor:pointer;">Confirm</button>
    </div>
  </div>
</div>

<script>
const SERVER_URL = "https://parkway-8fji.onrender.com/api/parking";

function toCssState(raw) {
  raw = String(raw || "").trim().toUpperCase();
  if (raw === "EMPTY" || raw === "FREE") return "free";
  if (raw === "RESERVED") return "reserved";
  if (raw === "OCCUPIED") return "occupied";
  return "free";
}

/* Load slot data from backend */
async function fetchSlots() {
  try {
    const res = await fetch(SERVER_URL);
    const data = await res.json();

    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      const status = toCssState(data[id]);
      el.classList.remove("free","reserved","occupied");
      el.classList.add(status);

      // clickable only if NOT occupied
      el.onclick = () => {
        if (status !== "occupied") openModal(id, status);
      };
    });
  } catch (err) {
    console.error(err);
  }
}

/* ---- MODAL FUNCTIONS ---- */
let selectedSlot = null;
let nextAction = null;

function openModal(slotId, status) {
  selectedSlot = slotId;
  nextAction = status === "free" ? "reserve" : "release";

  document.getElementById("modalTitle").textContent =
    nextAction === "reserve" ? "Reserve Slot" : "Release Slot";

  document.getElementById("modalText").innerHTML =
    nextAction === "reserve"
      ? `Confirm reservation for <strong>${slotId}</strong>?`
      : `Release reservation for <strong>${slotId}</strong>?`;

  document.getElementById("modal").classList.remove("hidden");
}

document.getElementById("cancelBtn").onclick = () => {
  document.getElementById("modal").classList.add("hidden");
};

/* Confirm reservation/release */
document.getElementById("confirmBtn").onclick = async () => {
  if (!selectedSlot) return;

  const payload =
    nextAction === "reserve"
      ? { status: "RESERVED", durationMinutes: 20 }
      : { status: "FREE" };

  try {
    await fetch(`${SERVER_URL}/${selectedSlot}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.error(e);
  }

  document.getElementById("modal").classList.add("hidden");
};

/* ---- Initialize map ---- */
document.addEventListener("DOMContentLoaded", () => {
  fetchSlots();
  setInterval(fetchSlots, 2000);
});
</script>



