<script>
const API_URL = "/api/parking";

// ---------- POPUP ----------
function reservePopup(slotId) {
  const ok = confirm(`Do you want to reserve ${slotId}?`);
  if (!ok) return;

  // Send RESERVED to backend
  fetch(`${API_URL}/${slotId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: "RESERVED" })
  })
  .then(res => res.json())
  .then(data => {
    console.log("Reserved:", data);
    alert(`${slotId} successfully reserved!`);
  })
  .catch(err => console.error("Reserve error:", err));
}

// ---------- STATUS NORMALIZER ----------
function normalizeStatus(s) {
  const st = String(s || "").trim().toUpperCase();
  if (st === "FREE" || st === "EMPTY") return "FREE";
  if (st === "RESERVED") return "RESERVED";
  if (st === "OCCUPIED") return "OCCUPIED";
  return "FREE"; // fallback
}

// ---------- LIVE MAP UPDATER ----------
let fetching = false;

async function fetchSlots() {
  if (fetching) return;
  fetching = true;

  try {
    const res = await fetch(API_URL, { cache: "no-store" });
    if (!res.ok) {
      console.error("Failed to fetch:", res.status);
      return;
    }

    const data = await res.json();

    Object.keys(data || {}).forEach(id => {
      const slotEl = document.getElementById(id);
      if (!slotEl) return;

      const status = normalizeStatus(data[id]);

      slotEl.classList.remove("free", "reserved", "occupied");

      if (status === "FREE") slotEl.classList.add("free");
      else if (status === "RESERVED") slotEl.classList.add("reserved");
      else if (status === "OCCUPIED") slotEl.classList.add("occupied");

      // ----- CLICK TO RESERVE -----
      slotEl.onclick = () => reservePopup(id);
    });

  } catch (err) {
    console.error("Error:", err);
  } finally {
    fetching = false;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  fetchSlots();
  setInterval(fetchSlots, 2000);
});
</script>
