<script>
/* BACKEND API */
const API_URL = "/api/parking";

/* Save + Load booking in browser */
function saveBooking(slotId) {
  localStorage.setItem("mySlot", slotId);
}
function clearBooking() {
  localStorage.removeItem("mySlot");
}
function getBooking() {
  return localStorage.getItem("mySlot") || "";
}

/* Normalize backend â†’ UI */
function normalizeStatus(s) {
  const st = String(s || "").trim().toUpperCase();
  if (st === "FREE" || st === "EMPTY") return "FREE";
  if (st === "RESERVED") return "RESERVED";
  if (st === "OCCUPIED") return "OCCUPIED";
  return "FREE";
}

/* When user clicks a slot */
function onSlotClick(slotId) {
  const confirmReserve = confirm(`Do you want to reserve ${slotId}?`);
  if (!confirmReserve) return;

  fetch(`${API_URL}/${slotId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: "RESERVED" })
  })
    .then(r => r.json())
    .then(d => {
      console.log("Reserved:", d);

      /* ðŸ”¥ Save booking locally */
      saveBooking(slotId);

      alert(`${slotId} reserved!`);
    })
    .catch(err => console.error("ERR:", err));
}

/* Fetch live statuses */
let fetching = false;
async function fetchSlots() {
  if (fetching) return;
  fetching = true;

  try {
    const res = await fetch(API_URL, { cache: "no-store" });
    if (!res.ok) return;

    const data = await res.json();

    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      const s = normalizeStatus(data[id]);

      el.classList.remove("free", "reserved", "occupied");
      if (s === "FREE") el.classList.add("free");
      if (s === "RESERVED") el.classList.add("reserved");
      if (s === "OCCUPIED") el.classList.add("occupied");

      /* Click â†’ reserve */
      el.onclick = () => onSlotClick(id);
    });

  } catch (err) {
    console.error(err);
  }

  fetching = false;
}

document.addEventListener("DOMContentLoaded", () => {
  fetchSlots();
  setInterval(fetchSlots, 2000);
});
</script>

