<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Parkway ‚Ä¢ My Booking</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Poppins", sans-serif;
  margin: 0;
  background: #0f2027;
  color: white;
}

.topbar { background: rgba(0,0,0,0.3); padding: 12px; display:flex; justify-content:space-between; }
.topbar a { color:#70afbb; text-decoration:none; margin-left:10px; }

.container { max-width:600px; margin:40px auto; padding:20px; }
.panel { background:rgba(255,255,255,0.05); padding:30px; border-radius:12px; text-align:center; }

.btn { padding:12px 20px; border:none; border-radius:6px; cursor:pointer; font-size:1rem; }
.btn.outline { background:none; border:2px solid #70afbb; color:#70afbb; }
.btn.green { background:#24ff6d; color:#07121a; font-weight:600; }
.mt { margin-top:18px; }
.small { font-size:0.8rem; opacity:0.8; }

/* ‚≠ê Flashing red text when < 60 sec ‚≠ê */
.flash-red {
  color:#ff5252;
  animation: flash 1s infinite alternate;
}
@keyframes flash {
  from { opacity:1; }
  to { opacity:0.3; }
}

/* Extend buttons container */
.extend-box { margin-top:20px; display:none; }
.extend-btn {
  margin:5px;
  padding:8px 14px;
  background:#ffd056;
  color:#07121a;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.extend-btn:hover {
  background:#ffcf3f;
}
</style>
</head>

<body>

<header class="topbar">
  <div class="brand"><a href="index.html">üöó Parkway</a></div>
  <nav class="navlinks">
    <a href="index.html">Home</a>
    <a href="map.html">Parking Map</a>
    <a href="booking.html">My Booking</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="about.html">How It Works</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<main class="container">
  <section class="panel">
    <h2>Your Booking</h2>
    <div id="bookingInfo" class="booking-card">No active booking.</div>

    <button id="releaseBtn" class="btn outline mt" style="display:none;">
      Release My Slot
    </button>

    <!-- ‚≠ê NEW: EXTEND RESERVATION -->
    <div id="extendBox" class="extend-box">
      <p>Extend your reservation:</p>
      <button class="extend-btn" onclick="extendReservation(5)">+5 min</button>
      <button class="extend-btn" onclick="extendReservation(10)">+10 min</button>
      <button class="extend-btn" onclick="extendReservation(15)">+15 min</button>
    </div>

    <p class="small mt">Tip: Select a slot on the <a href="map.html" style="color:#70afbb;">Parking Map</a> to reserve.</p>
  </section>
</main>

<script>
const API_URL = "/api/parking";
const infoBox = document.getElementById("bookingInfo");
const releaseBtn = document.getElementById("releaseBtn");
const extendBox = document.getElementById("extendBox");

let countdownTimer = null;

function stopCountdown() {
  if (countdownTimer) clearInterval(countdownTimer);
  countdownTimer = null;
}

function formatTime(ms) {
  const t = Math.floor(ms / 1000);
  const m = Math.floor(t / 60);
  const s = t % 60;
  return `${m}:${s.toString().padStart(2,"0")}`;
}

function showNoBooking() {
  stopCountdown();
  infoBox.textContent = "No active booking.";
  infoBox.classList.remove("flash-red");
  releaseBtn.style.display = "none";
  extendBox.style.display = "none";
  localStorage.removeItem("reservedSlot");
  localStorage.removeItem("reservedExpiry");
}

// FREE slot on server
async function freeSlot(slotId) {
  await fetch(`${API_URL}/${slotId}`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ status:"FREE" })
  });
}

// RELEASE BUTTON
releaseBtn.onclick = async () => {
  const slot = localStorage.getItem("reservedSlot");
  if (!slot) return;

  await freeSlot(slot);
  showNoBooking();

  // force refresh map
  fetch(`/api/parking?ts=${Date.now()}`);

  alert("Your slot has been released!");
};

// COUNTDOWN + FLASH < 60 SEC
function startCountdown(endTime, slot) {
  stopCountdown();

  countdownTimer = setInterval(() => {
    const left = endTime - Date.now();

    if (left <= 0) {
      freeSlot(slot);
      showNoBooking();
      return;
    }

    infoBox.textContent = `${slot} ‚Äî Reserved ‚Ä¢ expires in ${formatTime(left)}`;

    // ‚≠ê FLASH RED if less than 60 sec
    if (left < 60000) infoBox.classList.add("flash-red");
    else infoBox.classList.remove("flash-red");

  }, 1000);
}

// ‚≠ê EXTEND RESERVATION ‚≠ê
function extendReservation(mins) {
  let slot = localStorage.getItem("reservedSlot");
  let expiry = Number(localStorage.getItem("reservedExpiry"));

  if (!slot) return;

  // Add minutes
  const newExpiry = expiry + mins * 60000;
  localStorage.setItem("reservedExpiry", newExpiry);

  // Update server
  fetch(`${API_URL}/${slot}`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ status:"RESERVED", durationMinutes: mins })
  });

  startCountdown(newExpiry, slot);
  alert(`Reservation extended by ${mins} minutes.`);
}

// INITIAL LOAD
function updateUI() {
  const slot = localStorage.getItem("reservedSlot");
  let expiry = localStorage.getItem("reservedExpiry");

  if (!slot) {
    showNoBooking();
    return;
  }

  releaseBtn.style.display = "inline-block";
  extendBox.style.display = "block";

  if (!expiry) {
    // first-time booking ‚Üí set new expiry = 20 mins
    expiry = Date.now() + 20 * 60000;
    localStorage.setItem("reservedExpiry", expiry);
  }

  startCountdown(Number(expiry), slot);
}

updateUI();
</script>

</body>
</html>



