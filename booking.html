<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parkway ‚Ä¢ My Booking</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<header class="topbar">
  <div class="brand"><a href="index.html">üöó Parkway</a></div>
  <nav class="navlinks">
    <a href="index.html">Home</a>
    <a href="map.html">Parking Map</a>
    <a href="booking.html">My Booking</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="about.html">How It Works</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<main class="container narrow">
  <section class="panel glass center">
    <h2>Your Booking</h2>

    <div id="bookingInfo" class="booking-card">No active booking.</div>

    <button id="releaseBtn" class="btn outline mt" style="display:none;">
      Release My Slot
    </button>

    <p class="muted small mt">
      Tip: Select a slot on the <a href="map.html">Parking Map</a> to reserve.
    </p>
  </section>
</main>

<footer class="site-footer">
  <small>¬©Ô∏è <span id="year"></span> Parkway ‚Ä¢ Smart Parking System</small>
</footer>

<script>
document.getElementById("year").textContent = new Date().getFullYear();

const API_URL = "/api/parking";
const infoBox = document.getElementById("bookingInfo");
const releaseBtn = document.getElementById("releaseBtn");

let slot = localStorage.getItem("reservedSlot");
let expiry = localStorage.getItem("reservedExpiry");

function formatTime(ms) {
  const total = Math.floor(ms / 1000);
  const m = Math.floor(total / 60);
  const s = total % 60;
  return `${m}:${s.toString().padStart(2,'0')}`;
}

function showNoBooking() {
  infoBox.textContent = "No active booking.";
  releaseBtn.style.display = "none";

  localStorage.removeItem("reservedSlot");
  localStorage.removeItem("reservedExpiry");
}

async function updateUI() {

  slot = localStorage.getItem("reservedSlot");
  expiry = localStorage.getItem("reservedExpiry");

  if (!slot) {
    showNoBooking();
    return;
  }

  // Show button
  releaseBtn.style.display = "inline-block";

  // Handle countdown
  let target = expiry ? Number(expiry) : null;

  if (!target) {
    target = Date.now() + 20 * 60 * 1000; // 20 minutes
    localStorage.setItem("reservedExpiry", target);
  }

  function tick() {
    const left = target - Date.now();

    if (left <= 0) {
      // Auto-expire booking
      freeSlot(slot);
      showNoBooking();
      return;
    }

    infoBox.textContent = `${slot} ‚Äî Reserved ‚Ä¢ expires in ${formatTime(left)}`;
  }

  tick();
  setInterval(tick, 1000);
}

async function freeSlot(slotId) {
  try {
    await fetch(`${API_URL}/${slotId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: "FREE" })
    });
  } catch (e) {
    console.error("Release failed", e);
  }
}

releaseBtn.onclick = async () => {
  if (!slot) return;

  await freeSlot(slot);

  showNoBooking();

  alert("Your slot has been released!");
};

updateUI();
</script>

</body>
</html>


